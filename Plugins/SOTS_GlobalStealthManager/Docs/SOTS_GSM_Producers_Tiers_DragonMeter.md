# SOTS GSM Producers, Tiers & Dragon Meter

## Producers & event-driven push
- The LightProbe component samples the scene on a timer controlled by `ProbeUpdateInterval` and `World->GetTimerManager().SetTimer(...)` inside `BeginPlay`, guaranteeing uniform sampling cadence for every player pawn that hosts the probe ([Plugins/LightProbePlugin/Source/LightProbePlugin/Private/LightLevelProbeComponent.cpp](Plugins/LightProbePlugin/Source/LightProbePlugin/Private/LightLevelProbeComponent.cpp#L94-L116)).
- Normalized luminance is fed straight into `USOTS_PlayerStealthComponent::SetLightLevel` as soon as the probe finishes its capture, so the probe stays decoupled from GSM itself while the player component manages the downstream distribution ([Plugins/LightProbePlugin/Source/LightProbePlugin/Private/LightLevelProbeComponent.cpp](Plugins/LightProbePlugin/Source/LightProbePlugin/Private/LightLevelProbeComponent.cpp#L400-L405)).
- `USOTS_PlayerStealthComponent` is entirely event-driven: `SetLightLevel`, `SetCoverExposure`, and `SetMovementNoise` clamp inputs, recompute `LocalVisibility01`, fire `OnLocalVisibilityUpdated`, and then `PushStateToGlobalManager`, meaning GSM always receives the latest sample without any ticking actors ([Plugins/SOTS_GlobalStealthManager/Source/SOTS_GlobalStealthManager/Private/SOTS_PlayerStealthComponent.cpp](Plugins/SOTS_GlobalStealthManager/Source/SOTS_GlobalStealthManager/Private/SOTS_PlayerStealthComponent.cpp#L33-L96)).
- AI suspicion coming from `SetAISuspicion` is forwarded immediately to GSM so that the player component and GSM stay aligned even when a guard hiss is the only input ([Plugins/SOTS_GlobalStealthManager/Source/SOTS_GlobalStealthManager/Private/SOTS_PlayerStealthComponent.cpp](Plugins/SOTS_GlobalStealthManager/Source/SOTS_GlobalStealthManager/Private/SOTS_PlayerStealthComponent.cpp#L53-L69)).

## GSM ingestion, scoring & tier computation
- `USOTS_GlobalStealthManagerSubsystem::ReportStealthSample` accepts the `FSOTS_StealthSample`, builds a blended score (light, LOS, distance, noise, cover reduction) and clamps it before populating `CurrentStealthScore`, `CurrentState`, and `CurrentBreakdown`, so the subsystem owns the authoritative score calculation ([Plugins/SOTS_GlobalStealthManager/Source/SOTS_GlobalStealthManager/Private/SOTS_GlobalStealthManagerSubsystem.cpp](Plugins/SOTS_GlobalStealthManager/Source/SOTS_GlobalStealthManager/Private/SOTS_GlobalStealthManagerSubsystem.cpp#L93-L190)).
- `USOTS_PlayerStealthComponent` keeps `FSOTS_PlayerStealthState` current and calls `USOTS_GlobalStealthManagerSubsystem::UpdateFromPlayer`, which writes that struct into `CurrentState`, triggers `RecomputeGlobalScore`, and rebroadcasts `OnStealthStateChanged` so every listener (FX, UI, dragon) consumes the same snapshot ([Plugins/SOTS_GlobalStealthManager/Source/SOTS_GlobalStealthManager/Private/SOTS_GlobalStealthManagerSubsystem.cpp](Plugins/SOTS_GlobalStealthManager/Source/SOTS_GlobalStealthManager/Private/SOTS_GlobalStealthManagerSubsystem.cpp#L927-L1006); [Plugins/SOTS_GlobalStealthManager/Source/SOTS_GlobalStealthManager/Private/SOTS_GlobalStealthManagerSubsystem.cpp](Plugins/SOTS_GlobalStealthManager/Source/SOTS_GlobalStealthManager/Private/SOTS_GlobalStealthManagerSubsystem.cpp#L1261-L1266)).
- `RecomputeGlobalScore` fuses `CurrentState.LocalVisibility01`, `CurrentState.AISuspicion01`, modifier stack, and `ActiveConfig` weights to produce `ScoreForTier`, then it computes the tier via the `ComputeTierFromScore` lambda, applies hysteresis/`MinSecondsBetweenTierChanges`, and finally broadcasts tier transitions through `OnStealthTierChanged` alongside `OnStealthStateChanged` so downstream consumers can rely on a single canonical change stream ([Plugins/SOTS_GlobalStealthManager/Source/SOTS_GlobalStealthManager/Private/SOTS_GlobalStealthManagerSubsystem.cpp](Plugins/SOTS_GlobalStealthManager/Source/SOTS_GlobalStealthManager/Private/SOTS_GlobalStealthManagerSubsystem.cpp#L1060-L1266)).
- `SetAISuspicion` and `ReportAISuspicionEx` keep the suspicion term fresh, and `ReportEnemyDetectionEvent` updates `bPlayerDetected` plus fires `OnPlayerDetectionStateChanged`, so detection status is also part of the continuous path ([Plugins/SOTS_GlobalStealthManager/Source/SOTS_GlobalStealthManager/Private/SOTS_GlobalStealthManagerSubsystem.cpp](Plugins/SOTS_GlobalStealthManager/Source/SOTS_GlobalStealthManager/Private/SOTS_GlobalStealthManagerSubsystem.cpp#L195-L236); [Plugins/SOTS_GlobalStealthManager/Source/SOTS_GlobalStealthManager/Private/SOTS_GlobalStealthManagerSubsystem.cpp](Plugins/SOTS_GlobalStealthManager/Source/SOTS_GlobalStealthManager/Private/SOTS_GlobalStealthManagerSubsystem.cpp#L985-L990)).

## Continuous detection & alertness cadence
- `StartGlobalAlertnessDecayTimer` spins up a 0.25 s timer that invokes `UpdateGlobalAlertnessDecay`, keeping the global alertness value decaying toward its baseline even when no new samples arrive and broadcasting `OnGlobalAlertnessChanged` when the clamped value crosses thresholds ([Plugins/SOTS_GlobalStealthManager/Source/SOTS_GlobalStealthManager/Private/SOTS_GlobalStealthManagerSubsystem.cpp](Plugins/SOTS_GlobalStealthManager/Source/SOTS_GlobalStealthManager/Private/SOTS_GlobalStealthManagerSubsystem.cpp#L609-L683); [Plugins/SOTS_GlobalStealthManager/Source/SOTS_GlobalStealthManager/Private/SOTS_GlobalStealthManagerSubsystem.cpp](Plugins/SOTS_GlobalStealthManager/Source/SOTS_GlobalStealthManager/Private/SOTS_GlobalStealthManagerSubsystem.cpp#L2131-L2135)).
- The subsystem exposes `GetStealthState()`, `GetStealthTier()`, and `GetCurrentStealthBreakdown()` so every consumer sees the same derived state without re-running the scoring path ([Plugins/SOTS_GlobalStealthManager/Source/SOTS_GlobalStealthManager/Public/SOTS_GlobalStealthManagerSubsystem.h](Plugins/SOTS_GlobalStealthManager/Source/SOTS_GlobalStealthManager/Public/SOTS_GlobalStealthManagerSubsystem.h#L154-L169)).

## Dragon meter contract
- `USOTS_DragonStealthComponent` binds to `OnStealthStateChanged` in `BeginPlay`, caches the `FSOTS_PlayerStealthState`, and exposes getters for `LightLevel01`, `ShadowLevel01`, `GlobalStealthScore01`, `StealthTier`, `AISuspicion01`, and `OverallDetection01`, making the dragon’s visibility/distortion/tiers consumable without extra queries ([Plugins/SOTS_GlobalStealthManager/Source/SOTS_GlobalStealthManager/Private/SOTS_DragonStealthComponent.cpp](Plugins/SOTS_GlobalStealthManager/Source/SOTS_GlobalStealthManager/Private/SOTS_DragonStealthComponent.cpp#L17-L36); [Plugins/SOTS_GlobalStealthManager/Source/SOTS_GlobalStealthManager/Public/SOTS_DragonStealthComponent.h](Plugins/SOTS_GlobalStealthManager/Source/SOTS_GlobalStealthManager/Public/SOTS_DragonStealthComponent.h#L25-L40)).
- `FSOTS_PlayerStealthState` already bundles the full meter (light, shadow, cover, movement, AISuspicion, global score, tier), and GSM keeps that struct fresh before every broadcast, so dragon visuals rely on the exact same state every update ([Plugins/SOTS_GlobalStealthManager/Source/SOTS_GlobalStealthManager/Public/SOTS_GlobalStealthTypes.h](Plugins/SOTS_GlobalStealthManager/Source/SOTS_GlobalStealthManager/Public/SOTS_GlobalStealthTypes.h#L446-L474)).
- Because `OnStealthStateChanged` fires from both `ReportStealthSample` and `RecomputeGlobalScore` (and again after restores in `ResetStealthState`), there are no gaps between LightProbe/player inputs and the dragon meter—the subsystem is the single source of truth for score, tier, detection, and alertness status throughout the mission ([Plugins/SOTS_GlobalStealthManager/Source/SOTS_GlobalStealthManager/Private/SOTS_GlobalStealthManagerSubsystem.cpp](Plugins/SOTS_GlobalStealthManager/Source/SOTS_GlobalStealthManager/Private/SOTS_GlobalStealthManagerSubsystem.cpp#L186-L2130)).

## Summary
- Producers light/cover/noise/AISuspicion -> `USOTS_PlayerStealthComponent` -> `USOTS_GlobalStealthManagerSubsystem` pipeline is the single event-driven path through which GSM receives every update.
- `RecomputeGlobalScore`, `ComputeTierFromScore`, and the timer-backed alertness decay guarantee tier/detection are recalculated immediately and broadcast through `OnStealthStateChanged`/`OnStealthTierChanged`.
- `USOTS_DragonStealthComponent` consumes `FSOTS_PlayerStealthState` directly for the dragon meter, ensuring the dragon always sees the canonical score, tier, AISuspicion, and detection metrics.