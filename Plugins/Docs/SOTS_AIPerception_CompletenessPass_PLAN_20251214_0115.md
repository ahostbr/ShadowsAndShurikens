# SOTS_AIPerception Completeness Pass — Plan (2025-12-14 01:15)

## Scope
- Audit current planned behaviors for SOTS_AIPerception (component + subsystem + data) with focus on GSM reporting, suspicion/detection stability, BP surface clarity, and shipping/test safety.
- No runtime edits yet; this is a read-only inventory plus gap list and SPINE plan.

## Inventory (evidence)
- Core data model (state + visibility + blackboard config): [Plugins/SOTS_AIPerception/Source/SOTS_AIPerception/Public/SOTS_AIPerceptionTypes.h](Plugins/SOTS_AIPerception/Source/SOTS_AIPerception/Public/SOTS_AIPerceptionTypes.h#L11-L146).
- Guard tuning (sight/hearing thresholds, suspicion decay, debug flags): [Plugins/SOTS_AIPerception/Source/SOTS_AIPerception/Public/SOTS_AIPerceptionConfig.h](Plugins/SOTS_AIPerception/Source/SOTS_AIPerception/Public/SOTS_AIPerceptionConfig.h#L8-L191) and per-guard wrapper asset [Plugins/SOTS_AIPerception/Source/SOTS_AIPerception/Public/SOTS_AIGuardPerceptionDataAsset.h](Plugins/SOTS_AIPerception/Source/SOTS_AIPerception/Public/SOTS_AIGuardPerceptionDataAsset.h#L8-L23).
- Component public surface (suspicion getter, target state, suppression/force hooks, delegates): [Plugins/SOTS_AIPerception/Source/SOTS_AIPerception/Public/SOTS_AIPerceptionComponent.h](Plugins/SOTS_AIPerception/Source/SOTS_AIPerception/Public/SOTS_AIPerceptionComponent.h#L22-L155).
- Subsystem registration + noise broadcast: [Plugins/SOTS_AIPerception/Source/SOTS_AIPerception/Public/SOTS_AIPerceptionSubsystem.h](Plugins/SOTS_AIPerception/Source/SOTS_AIPerception/Public/SOTS_AIPerceptionSubsystem.h#L8-L46) and implementation [Plugins/SOTS_AIPerception/Source/SOTS_AIPerception/Private/SOTS_AIPerceptionSubsystem.cpp](Plugins/SOTS_AIPerception/Source/SOTS_AIPerception/Private/SOTS_AIPerceptionSubsystem.cpp#L7-L91).
- Blueprint noise entrypoint: [Plugins/SOTS_AIPerception/Source/SOTS_AIPerception/Public/SOTS_AIPerceptionLibrary.h](Plugins/SOTS_AIPerception/Source/SOTS_AIPerception/Public/SOTS_AIPerceptionLibrary.h#L8-L19) with implementation [Plugins/SOTS_AIPerception/Source/SOTS_AIPerception/Private/SOTS_AIPerceptionLibrary.cpp](Plugins/SOTS_AIPerception/Source/SOTS_AIPerception/Private/SOTS_AIPerceptionLibrary.cpp#L5-L31).

## Behavior sketch (current)
- Suspicion model: per-guard scalar `CurrentSuspicion` integrates LOS (SightSuspicionPerSecond, optional visibility multiplier) + hearing bump + shadow awareness; decays each tick; normalized via MaxSuspicion and sent to GSM every update [Plugins/SOTS_AIPerception/Source/SOTS_AIPerception/Private/SOTS_AIPerceptionComponent.cpp#L676-L853].
- State machine: awareness per-target (0..1) maps to thresholds (Soft/Hard/Alerted) and fires `OnTargetPerceptionChanged` [Plugins/SOTS_AIPerception/Source/SOTS_AIPerception/Private/SOTS_AIPerceptionComponent.cpp#L1023-L1134]. Highest state becomes component `CurrentState` and broadcasts `OnPerceptionStateChanged` [Plugins/SOTS_AIPerception/Source/SOTS_AIPerception/Private/SOTS_AIPerceptionComponent.cpp#L846-L1340].
- GSM reporting: per-tick `ReportAISuspicion` with normalized value; alert toggles call `ReportEnemyDetectionEvent` [Plugins/SOTS_AIPerception/Source/SOTS_AIPerception/Private/SOTS_AIPerceptionComponent.cpp#L781-L817] and [Plugins/SOTS_AIPerception/Source/SOTS_AIPerception/Private/SOTS_AIPerceptionComponent.cpp#L468-L483].
- Senses: Sight (FOV + LOS or multipoint LOS) drives awareness; Hearing bumps awareness via distance-scaled Delta [Plugins/SOTS_AIPerception/Source/SOTS_AIPerception/Private/SOTS_AIPerceptionComponent.cpp#L1048-L1127] and [Plugins/SOTS_AIPerception/Source/SOTS_AIPerception/Private/SOTS_AIPerceptionComponent.cpp#L484-L519]. Optional shadow awareness trace adds suspicion [Plugins/SOTS_AIPerception/Source/SOTS_AIPerception/Private/SOTS_AIPerceptionComponent.cpp#L706-L775].
- Blackboard/tag outputs: writes suspicion/state/LOS keys plus tag mapping per state/LOS [Plugins/SOTS_AIPerception/Source/SOTS_AIPerception/Private/SOTS_AIPerceptionComponent.cpp#L853-L1008] and [Plugins/SOTS_AIPerception/Source/SOTS_AIPerception/Private/SOTS_AIPerceptionComponent.cpp#L1168-L1248].
- Debug/telemetry: verbose log channel `LogSOTS_AIPerceptionTelemetry` gated by config booleans but not build-guarded; `bDebugSuspicion` adds UE_LOG(LogTemp, Verbose) without shipping/test guard [Plugins/SOTS_AIPerception/Source/SOTS_AIPerception/Private/SOTS_AIPerceptionComponent.cpp#L885-L895] and telemetry log [Plugins/SOTS_AIPerception/Source/SOTS_AIPerception/Private/SOTS_AIPerceptionComponent.cpp#L1341-L1412].

## Missing / risky behaviors (with proof)
- GSM ingest is unthrottled and reason-less: `ReportAISuspicion` fires every perception tick with only a float, no source breakdown or debounce [Plugins/SOTS_AIPerception/Source/SOTS_AIPerception/Private/SOTS_AIPerceptionComponent.cpp#L781-L817]. Alert toggle uses `ReportEnemyDetectionEvent` but no suspicion reason tagging [Plugins/SOTS_AIPerception/Source/SOTS_AIPerception/Private/SOTS_AIPerceptionComponent.cpp#L468-L483].
- Suspicion stability: thresholds apply directly with no hysteresis/min dwell; awareness and suspicion decay/recover linearly so Soft/Hard/Alerted can flicker near thresholds [Plugins/SOTS_AIPerception/Source/SOTS_AIPerception/Private/SOTS_AIPerceptionComponent.cpp#L1078-L1134] with thresholds set in config [Plugins/SOTS_AIPerception/Source/SOTS_AIPerception/Public/SOTS_AIPerceptionConfig.h#L52-L58]. Hearing adds a one-frame bump without rate limiting [Plugins/SOTS_AIPerception/Source/SOTS_AIPerception/Private/SOTS_AIPerceptionComponent.cpp#L484-L519].
- Event contract payloads are thin: `OnPerceptionStateChanged` has no payload beyond the enum (no target or reason) and `OnTargetPerceptionChanged` omits stimulus context/LOS flag [Plugins/SOTS_AIPerception/Source/SOTS_AIPerception/Public/SOTS_AIPerceptionComponent.h#L92-L100]. No explicit `OnTargetLost`/`OnFullyDetected` delegates.
- Multi-sense coverage is partial: only sight/hearing affect awareness; no damage/other senses; hearing lacks target attribution (bump applied to all watched targets) [Plugins/SOTS_AIPerception/Source/SOTS_AIPerception/Private/SOTS_AIPerceptionComponent.cpp#L484-L519].
- Target selection and perf: every update re-queries `GetAllActorsOfClass` for watched classes, then evaluates round-robin; no primary target pinning or multi-target suspicion partitioning [Plugins/SOTS_AIPerception/Source/SOTS_AIPerception/Private/SOTS_AIPerceptionComponent.cpp#L520-L619]. Suspicion is tied to single “best awareness” target, so multi-target contexts are lossy [Plugins/SOTS_AIPerception/Source/SOTS_AIPerception/Private/SOTS_AIPerceptionComponent.cpp#L676-L744].
- Shipping/Test safety: telemetry and debug suspicion logs are only config-gated, not build-gated; default bEnablePerceptionTelemetry false but LogVerbosity fires if enabled in shipping [Plugins/SOTS_AIPerception/Source/SOTS_AIPerception/Private/SOTS_AIPerceptionComponent.cpp#L1341-L1412] and [Plugins/SOTS_AIPerception/Source/SOTS_AIPerception/Private/SOTS_AIPerceptionComponent.cpp#L885-L895]. Debug draws are guarded, but suspicion logging is not.
- GSM ownership boundaries: component applies stealth tags directly via TagManager (`ApplyPerceptionStateTags`, LOS tags) instead of emitting only normalized inputs to GSM, which can duplicate GSM-owned tagging [Plugins/SOTS_AIPerception/Source/SOTS_AIPerception/Private/SOTS_AIPerceptionComponent.cpp#L1168-L1248].

## SPINE plan to execute next
- **SPINE_1 — GSM reporting polish:** Add normalized suspicion input batching/throttle, reason/context payloads (sense + LOS + visibility fraction), and ensure GSM receives only inputs (no direct tag writes). Remove/park any legacy direct tagging paths.
- **SPINE_2 — Suspicion model hardening:** Introduce hysteresis or min-dwell for Soft/Hard/Alerted, configurable ramp/decay clamps per sense, hearing rate-limit per target, and shadow-awareness gating (distance + LOS + cooldown).
- **SPINE_3 — Event contract polish:** Enrich delegates with payload structs (target, sense, LOS, suspicion01, state), add explicit OnTargetSpotted/OnTargetLost/OnFullyDetected signals, and ensure blueprint helpers expose last seen location and suspicion reasons without silent failure.
- **SPINE_4 — Multi-sense/target cleanup:** Attribute hearing to specific targets when known, keep per-target suspicion caches, and avoid recomputing GetAllActorsOfClass every tick (cache + validity checks). Make primary target selection deterministic and non-lossy for GSM reporting.
- **SPINE_5 — Lifecycle/reset policy:** Define stateless vs cached behavior; add reset hooks (BeginPlay/EndPlay/Suppression) that clear per-target suspicion/LOS and sync with GSM without ghost values.
- **SPINE_6 — Shipping/Test guards:** Wrap telemetry/logging/suspicion debug in !(UE_BUILD_SHIPPING || UE_BUILD_TEST); keep defaults OFF; document config defaults; ensure TagManager writes stay dev-only or are removed per GSM ownership.

## Blocker fix (2025-12-14)
- Removed the accidental global-scope duplicate of the suspicion drive block so the translation unit starts with includes + lifecycle methods only [Plugins/SOTS_AIPerception/Source/SOTS_AIPerception/Private/SOTS_AIPerceptionComponent.cpp#L1-L110].
- Canonical suspicion drive block remains inside `UpdatePerception()` [Plugins/SOTS_AIPerception/Source/SOTS_AIPerception/Private/SOTS_AIPerceptionComponent.cpp#L722-L815].

## Next steps
- Await approval to implement SPINE_1–6 inside Plugins/SOTS_AIPerception only. No builds/tests will be triggered.
