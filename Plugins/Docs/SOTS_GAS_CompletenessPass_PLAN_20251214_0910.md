# SOTS_GAS Completeness Pass — PLAN (2025-12-14 09:10)

## Evidence (current state)
- Ability component APIs (grant/activate/cancel, profile IO) live in [Plugins/SOTS_GAS_Plugin/Source/SOTS_GAS_Plugin/Public/Components/SOTS_AbilityComponent.h#L26-L152](Plugins/SOTS_GAS_Plugin/Source/SOTS_GAS_Plugin/Public/Components/SOTS_AbilityComponent.h#L26-L152).
- Activation path uses `TryActivateAbilityByTag` with inline gate checks and FX/UI side-effects; boolean + enum result only, no unified report ([Plugins/SOTS_GAS_Plugin/Source/SOTS_GAS_Plugin/Private/Components/SOTS_AbilityComponent.cpp#L538-L717](Plugins/SOTS_GAS_Plugin/Source/SOTS_GAS_Plugin/Private/Components/SOTS_AbilityComponent.cpp#L538-L717)).
- Cooldown/charges/profile snapshot logic exists but restores without versioning and skips missing defs silently ([Plugins/SOTS_GAS_Plugin/Source/SOTS_GAS_Plugin/Private/Components/SOTS_AbilityComponent.cpp#L760-L1106](Plugins/SOTS_GAS_Plugin/Source/SOTS_GAS_Plugin/Private/Components/SOTS_AbilityComponent.cpp#L760-L1106)).
- Registry is manual add-only; no deterministic bootstrap source, no duplicate/missing validation, no ready flag ([Plugins/SOTS_GAS_Plugin/Source/SOTS_GAS_Plugin/Private/Subsystems/SOTS_AbilityRegistrySubsystem.cpp#L13-L107](Plugins/SOTS_GAS_Plugin/Source/SOTS_GAS_Plugin/Private/Subsystems/SOTS_AbilityRegistrySubsystem.cpp#L13-L107)).
- Requirement evaluation pulls skill tags via `SOTS_GAS_SkillTreeLibrary`, player tags via `IGameplayTagAssetInterface`, stealth via `SOTS_GAS_StealthBridgeSubsystem`; no failure enums, only booleans and text ([Plugins/SOTS_GAS_Plugin/Source/SOTS_GAS_Plugin/Private/SOTS_GAS_AbilityRequirementLibrary.cpp#L10-L210](Plugins/SOTS_GAS_Plugin/Source/SOTS_GAS_Plugin/Private/SOTS_GAS_AbilityRequirementLibrary.cpp#L10-L210)).
- Profile subsystem stores granted tags/ranks/cooldowns as raw containers without versioning or validation ([Plugins/SOTS_GAS_Plugin/Source/SOTS_GAS_Plugin/Private/Subsystems/SOTS_AbilitySubsystem.cpp#L6-L104](Plugins/SOTS_GAS_Plugin/Source/SOTS_GAS_Plugin/Private/Subsystems/SOTS_AbilitySubsystem.cpp#L6-L104)).
- Ability definitions are DA-backed (`USOTS_AbilityDefinitionDA` / Library) with optional FX tags but no registry enforcement ([Plugins/SOTS_GAS_Plugin/Source/SOTS_GAS_Plugin/Public/Data/SOTS_AbilityDataAssets.h#L14-L74](Plugins/SOTS_GAS_Plugin/Source/SOTS_GAS_Plugin/Public/Data/SOTS_AbilityDataAssets.h#L14-L74)).
- Inventory gating calls SOTS_INV bridge when available but falls back to direct InvSP component mutation (copy-apply-clear) and owner interfaces, not the SOTS_INV facade with report semantics ([Plugins/SOTS_GAS_Plugin/Source/SOTS_GAS_Plugin/Private/Components/SOTS_AbilityComponent.cpp#L216-L311](Plugins/SOTS_GAS_Plugin/Source/SOTS_GAS_Plugin/Private/Components/SOTS_AbilityComponent.cpp#L216-L311)).
- Skill gating relies on `UBPI_SOTS_SkillTreeAccess::IsSkillUnlocked` without cached results or explicit failure surface ([Plugins/SOTS_GAS_Plugin/Source/SOTS_GAS_Plugin/Private/Components/SOTS_AbilityComponent.cpp#L168-L210](Plugins/SOTS_GAS_Plugin/Source/SOTS_GAS_Plugin/Private/Components/SOTS_AbilityComponent.cpp#L168-L210)).
- UI/FX side-effects fire inside activation path via `USOTS_UIAbilityLibrary::NotifyAbilityEvent` and `USOTS_FXManagerSubsystem::TriggerFXByTag`, but failures only emit logs/events without structured reasons ([Plugins/SOTS_GAS_Plugin/Source/SOTS_GAS_Plugin/Private/Components/SOTS_AbilityComponent.cpp#L527-L705](Plugins/SOTS_GAS_Plugin/Source/SOTS_GAS_Plugin/Private/Components/SOTS_AbilityComponent.cpp#L527-L705)).

## Missing behaviors / gaps (with proof)
1) **Deterministic registry/init** — No authoritative list or startup bootstrap; only ad-hoc `RegisterAbilityDefinition*` calls and no validation for duplicates/missing assets ([SOTS_AbilityRegistrySubsystem.cpp#L13-L72](Plugins/SOTS_GAS_Plugin/Source/SOTS_GAS_Plugin/Private/Subsystems/SOTS_AbilityRegistrySubsystem.cpp#L13-L72)).
2) **Unified activation contract** — Activation returns bool + enum, does not emit structured result or failure reason; gates and side-effects are scattered in `TryActivateAbilityByTag` ([SOTS_AbilityComponent.cpp#L538-L717](Plugins/SOTS_GAS_Plugin/Source/SOTS_GAS_Plugin/Private/Components/SOTS_AbilityComponent.cpp#L538-L717)).
3) **Inventory boundary** — Fallback paths directly read/mutate `UInvSP_InventoryComponent` items instead of SOTS_INV facade `_WithReport` APIs, violating seam ([SOTS_AbilityComponent.cpp#L216-L311](Plugins/SOTS_GAS_Plugin/Source/SOTS_GAS_Plugin/Private/Components/SOTS_AbilityComponent.cpp#L216-L311)).
4) **Skill gating clarity** — Uses skill interface per-call without cached unlock state or explicit failure enumeration; failure mapped to generic text only ([SOTS_AbilityComponent.cpp#L168-L210](Plugins/SOTS_GAS_Plugin/Source/SOTS_GAS_Plugin/Private/Components/SOTS_AbilityComponent.cpp#L168-L210)).
5) **Profile robustness** — Profile data stores raw tags/ranks/cooldowns with no version, no missing-def reconciliation, and Apply just overwrites containers ([SOTS_AbilitySubsystem.cpp#L25-L88](Plugins/SOTS_GAS_Plugin/Source/SOTS_GAS_Plugin/Private/Subsystems/SOTS_AbilitySubsystem.cpp#L25-L88); component Apply skips unknown defs silently [SOTS_AbilityComponent.cpp#L992-L1047](Plugins/SOTS_GAS_Plugin/Source/SOTS_GAS_Plugin/Private/Components/SOTS_AbilityComponent.cpp#L992-L1047)).
6) **Dev-only diagnostics** — No registry validation toggles, no activation audit logging flags; FX/UI notifications fire in all builds without opt-out ([SOTS_AbilityComponent.cpp#L538-L717](Plugins/SOTS_GAS_Plugin/Source/SOTS_GAS_Plugin/Private/Components/SOTS_AbilityComponent.cpp#L538-L717)).

## Planned SPINEs
- **SPINE_1 — Registry determinism & validation:** Add config-driven list of ability definition libraries (soft refs), build registry on init with ready flag, detect duplicates/missing AbilityClass/FX tags, dev-only warnings; guard all lookups on ready state.
- **SPINE_2 — Activation pipeline & result contract:** Centralize activation into `ProcessAbilityRequest` returning a `Result` struct + enum reason; route Blueprint/public helpers through it; ensure all gates (requirements, inventory, skill, cooldown, charges, owner tags) feed explicit reasons; emit BP delegates for started/ended/failed with reason; avoid side-effects in dev-off builds unless enabled.
- **SPINE_3 — Inventory boundary compliance:** Replace InvSP direct mutations with SOTS_INV facade/provider `_WithReport` APIs; surface consume failure as activation failure reason; keep bridge as first choice.
- **SPINE_4 — SkillTree gating clarity:** Cache unlock state (per component/subsystem), add explicit failure reasons (LockedBySkill/MissingPrereq), and thread through activation result.
- **SPINE_5 — Profile save/load hardening:** Version save schema, reconcile missing/extra defs deterministically with dev-only warnings, persist cooldown/charges/unlocked state via subsystem+component, expose import/export helpers for profile slice.
- **SPINE_6 — Dev-only diagnostics:** Add cvars/config toggles for registry validation, activation logging, and gate tracing; ensure Shipping/Test stays clean; provide optional debug trace delegate without touching UI widgets.
