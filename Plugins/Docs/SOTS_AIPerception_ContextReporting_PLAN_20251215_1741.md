# SOTS_AIPerception Context Reporting — PLAN snapshot 20251215_1741

## Current call surfaces (what exists today)
- GSM suspicion intake: ReportAISuspicion(AActor*, float) is the only public entry; it clamps and stores per-guard floats in GuardSuspicion and feeds AISuspicion01 max aggregation, with no context fields (reason/location/instigator) and no last-report record. See [Plugins/SOTS_GlobalStealthManager/Source/SOTS_GlobalStealthManager/Public/SOTS_GlobalStealthManagerSubsystem.h#L122-L190](Plugins/SOTS_GlobalStealthManager/Source/SOTS_GlobalStealthManager/Public/SOTS_GlobalStealthManagerSubsystem.h#L122-L190) and implementation at [Plugins/SOTS_GlobalStealthManager/Source/SOTS_GlobalStealthManager/Private/SOTS_GlobalStealthManagerSubsystem.cpp#L192-L260](Plugins/SOTS_GlobalStealthManager/Source/SOTS_GlobalStealthManager/Private/SOTS_GlobalStealthManagerSubsystem.cpp#L192-L260). GuardSuspicion backing store is declared at [Plugins/SOTS_GlobalStealthManager/Source/SOTS_GlobalStealthManager/Public/SOTS_GlobalStealthManagerSubsystem.h#L175-L183](Plugins/SOTS_GlobalStealthManager/Source/SOTS_GlobalStealthManager/Public/SOTS_GlobalStealthManagerSubsystem.h#L175-L183).
- AIPerception → GSM call site: USOTS_AIPerceptionComponent::ReportSuspicionToGSM forwards only (Actor, Suspicion01) despite computing ReasonTag and OptionalLocation; GSM drops both. Call happens inside UpdatePerception before tag/telemetry logging. See call in UpdatePerception at [Plugins/SOTS_AIPerception/Source/SOTS_AIPerception/Private/SOTS_AIPerceptionComponent.cpp#L955-L990](Plugins/SOTS_AIPerception/Source/SOTS_AIPerception/Private/SOTS_AIPerceptionComponent.cpp#L955-L990) and the implementation at [Plugins/SOTS_AIPerception/Source/SOTS_AIPerception/Private/SOTS_AIPerceptionComponent.cpp#L1996-L2062](Plugins/SOTS_AIPerception/Source/SOTS_AIPerception/Private/SOTS_AIPerceptionComponent.cpp#L1996-L2062).
- Noise pipeline (current data loss):
  - BP/C++ entry: USOTS_AIPerceptionLibrary::SOTS_TryReportNoise(World, Instigator, Location, Loudness, NoiseTag) → [Plugins/SOTS_AIPerception/Source/SOTS_AIPerception/Public/SOTS_AIPerceptionLibrary.h#L11-L30](Plugins/SOTS_AIPerception/Source/SOTS_AIPerception/Public/SOTS_AIPerceptionLibrary.h#L11-L30) and [Plugins/SOTS_AIPerception/Source/SOTS_AIPerception/Private/SOTS_AIPerceptionLibrary.cpp#L5-L36](Plugins/SOTS_AIPerception/Source/SOTS_AIPerception/Private/SOTS_AIPerceptionLibrary.cpp#L5-L36).
  - Subsystem hops: USOTS_AIPerceptionSubsystem::TryReportNoise(AActor* Instigator, FVector Location, float Loudness, FGameplayTag NoiseTag) broadcasts to all registered components but ignores NoiseTag/Instigator. See [Plugins/SOTS_AIPerception/Source/SOTS_AIPerception/Public/SOTS_AIPerceptionSubsystem.h#L19-L38](Plugins/SOTS_AIPerception/Source/SOTS_AIPerception/Public/SOTS_AIPerceptionSubsystem.h#L19-L38) and [Plugins/SOTS_AIPerception/Source/SOTS_AIPerception/Private/SOTS_AIPerceptionSubsystem.cpp#L24-L74](Plugins/SOTS_AIPerception/Source/SOTS_AIPerception/Private/SOTS_AIPerceptionSubsystem.cpp#L24-L74).
  - Component sink: USOTS_AIPerceptionComponent::HandleReportedNoise(const FVector& Location, float Loudness) drops NoiseTag and Instigator entirely; it only bumps hearing for the primary target and enqueues a forced GSM report with a hearing ReasonTag but still only sends (Actor, Suspicion01). See [Plugins/SOTS_AIPerception/Source/SOTS_AIPerception/Public/SOTS_AIPerceptionComponent.h#L143-L170](Plugins/SOTS_AIPerception/Source/SOTS_AIPerception/Public/SOTS_AIPerceptionComponent.h#L143-L170) and implementation at [Plugins/SOTS_AIPerception/Source/SOTS_AIPerception/Private/SOTS_AIPerceptionComponent.cpp#L560-L640](Plugins/SOTS_AIPerception/Source/SOTS_AIPerception/Private/SOTS_AIPerceptionComponent.cpp#L560-L640).
- Blackboard writes (dual surfaces today, no fallback logic):
  - Selector-based writes: In UpdatePerception, if PerceptionConfig is set, it writes Suspicion/State/HasLOS using FSOTS_AIPerceptionBlackboardConfig selectors unconditionally. See [Plugins/SOTS_AIPerception/Source/SOTS_AIPerception/Private/SOTS_AIPerceptionComponent.cpp#L1015-L1070](Plugins/SOTS_AIPerception/Source/SOTS_AIPerception/Private/SOTS_AIPerceptionComponent.cpp#L1015-L1070).
  - Legacy keys always written: UpdateBlackboardAndTags writes hard-coded keys TargetActor/HasLOSToTarget/LastKnownTargetLocation/Awareness/PerceptionState every tick regardless of selector validity. See [Plugins/SOTS_AIPerception/Source/SOTS_AIPerception/Private/SOTS_AIPerceptionComponent.cpp#L1285-L1365](Plugins/SOTS_AIPerception/Source/SOTS_AIPerception/Private/SOTS_AIPerceptionComponent.cpp#L1285-L1365). There is no “selectors valid → skip legacy” gate yet.
- Damage stimulus: No damage entrypoint exists. Types expose RampUpPerSecond_Damage but nothing binds to OnTakeAnyDamage/OnPointDamage; no damage structs/policies in Types. See [Plugins/SOTS_AIPerception/Source/SOTS_AIPerception/Public/SOTS_AIPerceptionTypes.h#L150-L205](Plugins/SOTS_AIPerception/Source/SOTS_AIPerception/Public/SOTS_AIPerceptionTypes.h#L150-L205).

## Call graph summary
- Noise: Library SOTS_TryReportNoise → Subsystem TryReportNoise → Component HandleReportedNoise → suspicion bump → ReportSuspicionToGSM (reason/location computed but discarded by GSM).
- Sight/shadow loop: UpdatePerception computes stimuli → UpdateSuspicionModel → ReportSuspicionToGSM → GSM ReportAISuspicion → GuardSuspicion map → AISuspicion01 aggregate.
- Blackboard: UpdatePerception writes selector keys; UpdateBlackboardAndTags writes legacy keys every frame.

## What will change (non-breaking surfaces to add)
- GSM: introduce FSOTS_AISuspicionReport payload with ReasonTag/Location/Instigator/Timestamp; add ReportAISuspicionEx(...) while keeping ReportAISuspicion wrapper; store last report per guard + readonly getter; fire OnAISuspicionReported delegate when accepted.
- AIPerception → GSM: keep existing call but send ReportAISuspicionEx with reason/location/instigator; preserve min-delta/min-interval throttles.
- Noise: plumb NoiseTag+Instigator through subsystem and component signatures; classify instigator relation before applying; GSM report uses ReasonTag_Hearing (or policy override) and noise location.
- Blackboard: make selector keys canonical; write legacy keys only when selector is unset/invalid and emit one-time warning per actor when falling back.
- Damage: add stimulus structs/policies, bind to damage events, classify relation, apply suspicion impulse + optional state floor, and GSM report with ReasonTag_Damage + optional location.

## Quick evidence trail
- ad_hoc_regex_search run: pattern `ReportAISuspicion` on Plugins (DevTools script) at 2025-12-15T22:40Z; match counts logged in terminal (see transcript).