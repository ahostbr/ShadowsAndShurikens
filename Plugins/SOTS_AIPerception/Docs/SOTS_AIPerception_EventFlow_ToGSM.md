# SOTS_AIPerception Event Flow to GSM

## Purpose
Ensure the AI perception pipeline still meets the locked responsibilities for noise/damage payloads, GSM detection tiers, and FX/telemetry discipline before the next sweep.

## 1. Stimulus intake
- Blueprint callers use `USOTS_AIPerceptionLibrary::SOTS_TryReportNoise` and `SOTS_TryReportDamageStimulus` to bind into the world context, log missing subsystems via `LogSOTS_AIPerception`, and forward into `USOTS_AIPerceptionSubsystem` for delivery ([Plugins/SOTS_AIPerception/Source/SOTS_AIPerception/Private/SOTS_AIPerceptionLibrary.cpp](Plugins/SOTS_AIPerception/Source/SOTS_AIPerception/Private/SOTS_AIPerceptionLibrary.cpp#L7-L96)).
- The subsystem iterates registered components for noise (`TryReportNoise`) or routes the damage stimulus to the owning component (`TryReportDamageStimulus`), so gameplay only needs to know about the subsystem hooks ([Plugins/SOTS_AIPerception/Source/SOTS_AIPerception/Private/SOTS_AIPerceptionSubsystem.cpp](Plugins/SOTS_AIPerception/Source/SOTS_AIPerception/Private/SOTS_AIPerceptionSubsystem.cpp#L30-L120)).

## 2. Stimulus processing & suspicion payloads
- `HandleReportedNoise` clamps location/loudness, applies `FSOTS_NoiseStimulusPolicy` overrides, refreshes the reason tag, and immediately marks the stimulus for telemetry/logging before calling `ReportSuspicionToGSM` with `bForceReport=true`, ensuring every delivered noise still moistens the GSM feed ([Plugins/SOTS_AIPerception/Source/SOTS_AIPerception/Private/SOTS_AIPerceptionComponent.cpp](Plugins/SOTS_AIPerception/Source/SOTS_AIPerception/Private/SOTS_AIPerceptionComponent.cpp#L645-L780)).
- `ApplyDamageStimulus` evaluates ignore lists, range/cooldown, scales `SuspicionImpulse` via `FSOTS_DamageStimulusPolicy`, captures a resolved location and reason tag, records the last damage snapshot, and—because the policy defaults `bAlwaysReportToGSM`—forwards the normalized suspicion (plus location/instigator) to `ReportSuspicionToGSM` while caching `PendingGSMLocation`/`PendingGSMReasonTag` for the next update frame ([Plugins/SOTS_AIPerception/Source/SOTS_AIPerception/Private/SOTS_AIPerceptionComponent.cpp](Plugins/SOTS_AIPerception/Source/SOTS_AIPerception/Private/SOTS_AIPerceptionComponent.cpp#L803-L938)).
- Both policies are declared alongside the `FSOTS_AIGuardPerceptionConfig` so designers can tune cooldowns, deltas, FX tags, GSM throttles, and reason tags ([Plugins/SOTS_AIPerception/Source/SOTS_AIPerception/Public/SOTS_AIPerceptionTypes.h](Plugins/SOTS_AIPerception/Source/SOTS_AIPerception/Public/SOTS_AIPerceptionTypes.h#L126-L374)).

## 3. Suspicion updates, telemetry, and enforced GSM reporting
- `UpdatePerception` aggregates sight/hearing/shadow scores, sets `bForceReportThisFrame` when the highest sensed state differs from `CurrentState`, and calls `ReportSuspicionToGSM` on that frame so the GSM feed is never left hanging during threshold transitions ([Plugins/SOTS_AIPerception/Source/SOTS_AIPerception/Private/SOTS_AIPerceptionComponent.cpp](Plugins/SOTS_AIPerception/Source/SOTS_AIPerception/Private/SOTS_AIPerceptionComponent.cpp#L1260-L1345)).
- `BuildTelemetrySnapshot` and `BroadcastSuspicionTelemetry` capture AMPLED suspicion, the dominant reason tag, the last stimulus actor/location/time, and use `LogSOTS_AIPerceptionTelemetry` (never `LogTemp`) to emit optional developer logs tied to the telemetry struct ([Plugins/SOTS_AIPerception/Source/SOTS_AIPerception/Private/SOTS_AIPerceptionComponent.cpp](Plugins/SOTS_AIPerception/Source/SOTS_AIPerception/Private/SOTS_AIPerceptionComponent.cpp#L2294-L2404); [Plugins/SOTS_AIPerception/Source/SOTS_AIPerception/Public/SOTS_AIPerceptionTypes.h](Plugins/SOTS_AIPerception/Source/SOTS_AIPerception/Public/SOTS_AIPerceptionTypes.h#L374-L390)).

## 4. GSM handshake, tagging, and state broadcasts
- `ReportSuspicionToGSM` enforces `GuardConfig->Config.bEnableGSMReporting`, compares `GSMReportMinIntervalSeconds`/`GSMReportMinDelta01`, resolves the `USOTS_GlobalStealthManagerSubsystem`, and calls `ReportAISuspicionEx` with the clamped suspicion, reason tag, and optional location/instigator payload so GSM always receives structured telemetry ([Plugins/SOTS_AIPerception/Source/SOTS_AIPerception/Private/SOTS_AIPerceptionComponent.cpp](Plugins/SOTS_AIPerception/Source/SOTS_AIPerception/Private/SOTS_AIPerceptionComponent.cpp#L2429-L2518)).
- Any perception state change flows through `SetPerceptionState`, which updates tags, notifies the global stealth manager, and invokes `HandlePerceptionStateChanged`. `NotifyGlobalStealthManager` calls `ReportAlertStateChanged` so `USOTS_GlobalStealthManagerSubsystem::ReportEnemyDetectionEvent` knows when `Alerted` flips ([Plugins/SOTS_AIPerception/Source/SOTS_AIPerception/Private/SOTS_AIPerceptionComponent.cpp](Plugins/SOTS_AIPerception/Source/SOTS_AIPerception/Private/SOTS_AIPerceptionComponent.cpp#L1771-L1905)).
- `ApplyPerceptionStateTags`/`ApplyLOSStateTags` keep `USOTS_GameplayTagManagerSubsystem` up to date with the scripted tags for awareness states or whether the guard currently has LOS to the player, guaranteeing other systems can read stable tags ([Plugins/SOTS_AIPerception/Source/SOTS_AIPerception/Private/SOTS_AIPerceptionComponent.cpp](Plugins/SOTS_AIPerception/Source/SOTS_AIPerception/Private/SOTS_AIPerceptionComponent.cpp#L1771-L1870)).

## 5. FX execution & logging discipline
- `HandlePerceptionStateChanged` consults `GuardConfig` fx tags and fires them through `USOTS_FXManagerSubsystem::TriggerFXByTag` with the perception component as context, ensuring all cues run through the FX manager and avoid ad-hoc spawns ([Plugins/SOTS_AIPerception/Source/SOTS_AIPerception/Private/SOTS_AIPerceptionComponent.cpp](Plugins/SOTS_AIPerception/Source/SOTS_AIPerception/Private/SOTS_AIPerceptionComponent.cpp#L1390-L1452)).
- `LogSOTS_AIPerception`/`LogSOTS_AIPerceptionTelemetry` are defined at the top of the component so every printout about missing GSM, telemetry dumps, or library failures uses the same categories; no `LogTemp` usage exists anywhere in the component or library ([Plugins/SOTS_AIPerception/Source/SOTS_AIPerception/Private/SOTS_AIPerceptionComponent.cpp](Plugins/SOTS_AIPerception/Source/SOTS_AIPerception/Private/SOTS_AIPerceptionComponent.cpp#L24-L37)).

## Responsibilities verified
1. `HandleReportedNoise` and `ApplyDamageStimulus` ensure noise/damage carry reason arguments, instigator/location data, and call `ReportSuspicionToGSM` with forced `bForceReport` or `bAlwaysReportToGSM` flags so the GSM stream always receives a concrete payload ([Plugins/SOTS_AIPerception/Source/SOTS_AIPerception/Private/SOTS_AIPerceptionComponent.cpp](Plugins/SOTS_AIPerception/Source/SOTS_AIPerception/Private/SOTS_AIPerceptionComponent.cpp#L645-L938)).
2. GSM throttling is controlled by `FSOTS_AIGuardPerceptionConfig` while `ReportSuspicionToGSM` and `ReportAlertStateChanged` guarantee the global stealth manager gets both AISuspicion deltas and alert-state transitions ([Plugins/SOTS_AIPerception/Source/SOTS_AIPerception/Private/SOTS_AIPerceptionComponent.cpp](Plugins/SOTS_AIPerception/Source/SOTS_AIPerception/Private/SOTS_AIPerceptionComponent.cpp#L1771-L2518); [Plugins/SOTS_AIPerception/Source/SOTS_AIPerception/Public/SOTS_AIPerceptionTypes.h](Plugins/SOTS_AIPerception/Source/SOTS_AIPerception/Public/SOTS_AIPerceptionTypes.h#L223-L374)).
3. `HandlePerceptionStateChanged` is the only code path that talks to `USOTS_FXManagerSubsystem`, so all FX cues run as one-shots through the manager using the right log categories, and `BroadcastSuspicionTelemetry` satisfies the telemetry requirement without `LogTemp` ([Plugins/SOTS_AIPerception/Source/SOTS_AIPerception/Private/SOTS_AIPerceptionComponent.cpp](Plugins/SOTS_AIPerception/Source/SOTS_AIPerception/Private/SOTS_AIPerceptionComponent.cpp#L1390-L1452); [Plugins/SOTS_AIPerception/Source/SOTS_AIPerception/Private/SOTS_AIPerceptionComponent.cpp](Plugins/SOTS_AIPerception/Source/SOTS_AIPerception/Private/SOTS_AIPerceptionComponent.cpp#L2294-L2404); [Plugins/SOTS_AIPerception/Source/SOTS_AIPerception/Private/SOTS_AIPerceptionComponent.cpp](Plugins/SOTS_AIPerception/Source/SOTS_AIPerception/Private/SOTS_AIPerceptionComponent.cpp#L24-L37)).

If any of the above sections needs deeper cross-reference (e.g., damage policies, FSM tags, or telemetry delegates) the linked source spans should provide a complete read on how the component carries the data to GSM, TagManager, FX, and telemetry callbacks.