# MCP_RAG_2 — First-class RAG tools + allowlisted scripts

Timestamp
- 2025-12-27 08:45 (local)

Goal
- Make SOTS RAG callable from MCP in a way that aligns with the MCP server’s reports directory and doesn’t require changing `sots_rag` defaults.

Changes (add-only, minimal)
1) Extended DevTool allowlist
- Added allowlist keys in the MCP server:
  - `rag_index` → `DevTools/python/sots_rag/run_rag_index.py`
  - `rag_query` → `DevTools/python/sots_rag/run_rag_query.py`
- Marked as read-only (via existing allowlist meta pattern).

2) Added first-class MCP tools
- `sots_rag_status`
  - Reports whether `DevTools/python/reports/RAG` exists and whether `rag_index_report.txt` exists.
  - Returns mtimes/sizes.
- `sots_rag_index`
  - Runs the indexer with:
    - `--project_root <RepoRoot>`
    - `--reports_dir <DevTools/python/reports/RAG>`
  - Returns:
    - Raw run output (stdout/stderr/returncode)
    - Contents of `rag_index_report.txt` if present
    - A small “outputs live here” block
- `sots_rag_query`
  - Runs the query tool with:
    - `--project_root <RepoRoot>`
    - `--reports_dir <DevTools/python/reports/RAG>`
    - `--q <query>`
    - `--top_k <N>`
    - `--scope <docs|code|all>`
  - Parses stdout line: `Reports: <...>.txt, <...>.json`
  - Reads the `.json` report and returns the parsed JSON object.

3) Updated smoketest
- Extended `sots_smoketest_all` with cheap RAG readiness checks:
  - Scripts present (`run_rag_index.py`, `run_rag_query.py`)
  - Reports root exists and is writable
  - `import sots_rag` viability

4) Updated help surface
- Added `sots_rag_status`, `sots_rag_index`, `sots_rag_query` to the `sots_help` canonical tool list.
- Updated the `sots_run_devtool` docstring list to include `rag_index` and `rag_query`.

Files touched
- DevTools/python/sots_mcp_server/server.py

How to call (examples)
- Status:
  - Tool: `sots_rag_status`
  - Params: `{}`

- Index:
  - Tool: `sots_rag_index`
  - Params: `{ "extra_args": ["--verbose"] }`

- Query (code scope):
  - Tool: `sots_rag_query`
  - Params: `{ "query": "Where is REPORTS_DIR defined?", "top_k": 12, "scope": "code" }`

Notes / risks / unknowns
- UNVERIFIED: MCP runtime execution of these tools in-editor (no Unreal run).
- The MCP server uses `_run_python()` which invokes `python` via subprocess; correctness depends on the runtime environment PATH having a usable Python.
